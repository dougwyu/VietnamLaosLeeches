---
title: "Vietnam Leeches"
author: "Douglas Yu"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(readxl)
library(vegan)
```

## Read data

```{r read data}
lowreadthreshold <- 100
leechidna <- read_excel("allWWFWCS_BFCusearchMF_CROP98_otu_TAX20161217_20170302.xlsx", sheet = "16Svert", skip = 1)
leechidna <- leechidna[ , 2:720] # can't use dplyr::select because some of the columns have duplicate names, and select can't handle that
names(leechidna)
leechidna <- leechidna %>% filter(Total_reads >= lowreadthreshold | Family %in% c("Manidae", "Lorisidae") & Total_reads >= 20) # filter out low-read OTUs but keep slow loris and pangolin
```

```{r sum read numbers by taxonomy}
names(leechidna)
leechidna2 <- leechidna %>% group_by(OTUs_merged_by_taxonomy) %>% summarise_at(vars(WWF1:WWF465), sum)
names(leechidna2)
# leechidna2$OTUs_merged_by_taxonomy
```

```{r remove negative controls}
negctrls <- c("BM","H1s","H2s","H3s","Q1s","Q2s","Q3s","XS2","XS5","XS6","XS7","XS8","XS9","SWG1s","SWG2s","XS1s","XS2s","2015Dec")

leechidna3 <- leechidna2

for(i in 1:length(negctrls)) {
	leechidna3 <- leechidna3 %>% select(-starts_with(negctrls[i]))
}

# names(leechidna3)
# leechidna3 <- leechidna2 %>% select(-starts_with(neg[1]), -starts_with(neg[2]), -starts_with(neg[3]), -starts_with(neg[4]), -starts_with(neg[5]), -starts_with(neg[6]), -starts_with(neg[7]), -starts_with(neg[8]), -starts_with(neg[9]), -starts_with(neg[10]), -starts_with(neg[11]), -starts_with(neg[12]), -starts_with(neg[13]), -starts_with(neg[14]), -starts_with(neg[15]), -starts_with(neg[16]), -starts_with(neg[17]), -starts_with(neg[18])) # slow way
```

```{r add total_reads and incidence columns}
leechidna3$total_reads <- leechidna3 %>% select(-OTUs_merged_by_taxonomy) %>% rowSums()

leechidna3$incidence <- leechidna3 %>% select(-OTUs_merged_by_taxonomy, -total_reads) %>% specnumber(MARGIN=1)

# names(leechidna3)
# leechidna3$incidence
# leechidna3$total_reads
```

```{r filter by taxonomy}
taxa_to_remove <- c("Actinopterygii|Amphibia|Archelosauria|lab contamination|laboratory contamination")
leechidna4 <- leechidna3 %>% filter(!grepl(taxa_to_remove, OTUs_merged_by_taxonomy))
# leechidna4$OTUs_merged_by_taxonomy

leechidna_Mammalia <- leechidna4 %>% filter(!grepl(c("no assignment|root"), OTUs_merged_by_taxonomy))

leechidna_Carnivora <- leechidna4 %>% filter(grepl(c("Carnivora"), OTUs_merged_by_taxonomy))

leechidna_smallcritters <- leechidna4 %>% filter(grepl(c("Rodentia|Scandentia|Lagomorpha|Insectivora"), OTUs_merged_by_taxonomy))

leechidna_Artiodactyla <- leechidna4 %>% filter(grepl(c("Artiodactyla"), OTUs_merged_by_taxonomy))

leechidna_Primates <- leechidna4 %>% filter(grepl(c("Primates"), OTUs_merged_by_taxonomy))

leechidna_Pholidota <- leechidna4 %>% filter(grepl(c("Pholidota"), OTUs_merged_by_taxonomy))


```


transpose taxonomic subsets to community 
join sample name to nature reserve name
heatmap
ordination biplot to see if i can merge some more OTUs




